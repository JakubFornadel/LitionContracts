<html>
   <script src='bignumber.js'></script>
   <script src="web3.min.js"></script>
   <script>
      var vestingContractAddress = '0xe8c845b1c99df84a743e7d7f63e495f93c7f2481';
      var vestingAbi = JSON.parse('[{"constant":true,"inputs":[],"name":"seedPrivateAdvisorVesting","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_sendTo","type":"address"}],"name":"claimUnallocated","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"communityVesting","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_beneficiary","type":"address"},{"name":"_tokens","type":"uint256"},{"name":"_startTime","type":"uint256"},{"name":"user","type":"uint8"}],"name":"initializeVesting","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalAllocated","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"claimTokens","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"teamVesting","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"renounceOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"userCategory","outputs":[{"name":"","type":"uint8"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"isOwner","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"ecosystemVesting","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"token","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"_token","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_to","type":"address"},{"indexed":false,"name":"_tokensReleased","type":"uint256"},{"indexed":false,"name":"user","type":"uint8"}],"name":"TokensReleased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"previousOwner","type":"address"},{"indexed":true,"name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"}]');
      const fileName = 'users.csv';

      var users = [{address:"0x86D7908C47bE59CBDd8058749C5a96FB337c0937", tokens:100, start:1555459200, type:1 }, 
                   {address:"0xEf910C08989b1AB6266178A39B0819eeB95715fD", tokens:200, start:1555459200, type:1 }];
      var userCount=2

      async function executeNext(i, vesting, account) {
         if (i>=userCount)
            return;
         console.log("Account used to sign: " + account.address);
         let baseNonce = await web3.eth.getTransactionCount(account.address);

         let vestingTx = vesting.methods.initializeVesting(users[i].address, users[i].tokens, users[i].start, users[i].type).encodeABI();
         let tx = {
            from: account.address,
            to: "0xe8c845b1c99df84a743e7d7f63e495f93c7f2481",
            data: vestingTx,
            gas: 250000,
            gasPrice: 20000000000,
            chainId: 3,
            nonce:     baseNonce
         }
         let signedTx = await account.signTransaction(tx);
         web3.eth.sendSignedTransaction(signedTx.rawTransaction)
            .on('receipt', (receipt) => {
               document.getElementById("p1").innerHTML += "<br/> User #"+i+" added\n";
               executeNext(i+1, vesting, account);
            })
            .on('error', console.error);
      }

      window.addEventListener('load', () => {
         if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
         } else {
            console.log("No web3, enable metamask");
            web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'));
         }
         var account = web3.eth.accounts.privateKeyToAccount("0x87EB33C6746C117131992F34B6DF13E7306B4FAFD8AFD72732BD861A0F780CEC");
         var vesting = new web3.eth.Contract(vestingAbi, vestingContractAddress);
//         var batch = new web3.BatchRequest();
//         for (i=0; i<userCount; i++) {
//            batch.add(vesting.methods.initializeVesting(users[i].address, users[i].tokens, users[i].start, users[i].type)
//               .send.request({from:"0x86D7908C47bE59CBDd8058749C5a96FB337c0937", gas:250000, gasPrice: 20000000000 }));
//         }
//         batch.execute();
         executeNext(0, vesting, account);
         console.log("Done!!!");
      });



   </script>
   <p id="p1">Hello World!</p>


</html>
